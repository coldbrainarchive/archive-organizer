<!doctype html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Archive</title>

<style>
html,body{
  margin:0;
  width:100%;
  height:100%;
  background:#000;
  overflow:hidden;
}
canvas{ position:fixed; inset:0; }
#fade{
  position:fixed;
  inset:0;
  background:#000;
  opacity:0;
  pointer-events:none;
  transition:opacity .45s ease;
  z-index:5;
}
video{
  position:fixed;
  inset:0;
  width:100%;
  height:100%;
  object-fit:cover;
  background:#000;
  z-index:10;
  pointer-events:none;
}
</style>
</head>

<body>

<canvas id="c"></canvas>
<div id="fade"></div>

<script>
const API = "/api/random";

/***********************
 * AUDIO (HARD FIX)
 ***********************/
let audioCtx, analyser, mediaSource;

function unlockAudio(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  audioCtx.resume();
}

/***********************
 * CANVAS
 ***********************/
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");
let W,H;

function resize(){
  W = canvas.width = innerWidth;
  H = canvas.height = innerHeight;
}
addEventListener("resize", resize);
resize();

/***********************
 * PARTICLES
 ***********************/
let particles=[];
let audioLevel=0;

function createParticles(){
  particles = Array.from({length:90}, ()=>({
    x:Math.random()*W,
    y:Math.random()*H,
    r:Math.random()*3+1,
    vx:(Math.random()-.5)*.4,
    vy:(Math.random()-.5)*.4,
    a:Math.random()*.6+.2
  }));
}
createParticles();

/***********************
 * DRAW
 ***********************/
function draw(){
  ctx.clearRect(0,0,W,H);
  for(const p of particles){
    p.x+=p.vx; p.y+=p.vy;
    if(p.x<0)p.x=W;if(p.x>W)p.x=0;
    if(p.y<0)p.y=H;if(p.y>H)p.y=0;

    ctx.beginPath();
    ctx.arc(p.x,p.y,p.r + audioLevel*4,0,Math.PI*2);
    ctx.fillStyle=`rgba(255,255,255,${p.a})`;
    ctx.fill();
  }
  requestAnimationFrame(draw);
}
draw();

/***********************
 * INTERACTION
 ***********************/
let playing=false;

canvas.addEventListener("pointerdown", async e=>{
  if(playing) return;
  playing = true;

  unlockAudio(); // MUST be here

  // ðŸ”¥ FETCH FIRST (still inside gesture)
  const res = await fetch(API);
  const data = await res.json();
  if(!data.ok){ reset(); return; }

  // ðŸ”¥ PLAY VIDEO IMMEDIATELY
  playVideo(data.url);

  // visuals can lag safely
  setTimeout(()=>fade(1), 250);
});

/***********************
 * VIDEO + AUDIO (BULLETPROOF)
 ***********************/
function playVideo(url){
  const vid=document.createElement("video");
  vid.src=url;
  vid.muted=true;
  vid.playsInline=true;
  vid.preload="auto";
  document.body.appendChild(vid);

  // attach audio graph BEFORE play
  mediaSource = audioCtx.createMediaElementSource(vid);
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 64;
  mediaSource.connect(analyser);
  analyser.connect(audioCtx.destination);

  vid.play().then(()=>{ vid.muted=false; }).catch(()=>{});

  const arr=new Uint8Array(analyser.frequencyBinCount);
  (function audioLoop(){
    if(!playing) return;
    analyser.getByteFrequencyData(arr);
    audioLevel = arr.reduce((a,b)=>a+b,0)/arr.length/255;
    requestAnimationFrame(audioLoop);
  })();

  vid.onended = cleanup;
  vid.onerror = cleanup;

  function cleanup(){
    vid.remove();
    reset();
  }
}

/***********************
 * HELPERS
 ***********************/
function fade(v){ document.getElementById("fade").style.opacity=v; }
function reset(){
  fade(0);
  playing=false;
  audioLevel=0;
  createParticles();
}
</script>

</body>
</html>
