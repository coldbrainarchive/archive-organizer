<!doctype html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Archive</title>

<style>
html,body{
  margin:0;
  width:100%;
  height:100%;
  background:#000;
  overflow:hidden;
}
canvas{ position:fixed; inset:0; }

#fade{
  position:fixed;
  inset:0;
  background:#000;
  opacity:0;
  pointer-events:none;
  transition:opacity .45s ease;
  z-index:5;
}

video{
  position:fixed;
  inset:0;
  width:100%;
  height:100%;
  object-fit:cover;
  background:#000;
  z-index:10;
  transition:opacity .4s ease;
}
</style>
</head>

<body>

<canvas id="c"></canvas>
<div id="fade"></div>

<script>
const API="/api/random";

/***********************
 * AUDIO STATE
 ***********************/
let audioCtx=null, analyser=null, mediaSource=null;
let audioReady=false;

/***********************
 * CAMERA PHYSICS
 ***********************/
let camX=0, camY=0;
let velX=0, velY=0;
let zoom=1;
let targetZoom=1;
let rotation=0;
let rotVel=0;

/***********************
 * INPUT STATE
 ***********************/
let dragging=false;
let lastX=0,lastY=0;
let gyroX=0,gyroY=0;

/***********************
 * CANVAS
 ***********************/
const canvas=document.getElementById("c");
const ctx=canvas.getContext("2d");
let W,H;

function resize(){
  W=canvas.width=innerWidth;
  H=canvas.height=innerHeight;
}
addEventListener("resize",resize);
resize();

/***********************
 * PARTICLES (DEPTH LAYERS)
 ***********************/
const DEPTHS=[0.4,0.7,1];
let particles=[];
let audioLevel=0;

function createParticles(){
  particles=[];
  for(const d of DEPTHS){
    for(let i=0;i<30;i++){
      particles.push({
        x:Math.random()*W*2,
        y:Math.random()*H*2,
        r:(Math.random()*2+1)*d,
        depth:d,
        a:Math.random()*.6+.2,

        // ðŸ”¥ SLOWED DOWN
        vx:(Math.random()-.5)*0.08*d,
        vy:(Math.random()-.5)*0.08*d,

        // screen-space cache for hit testing
        sx:0,
        sy:0
      });
    }
  }
}
createParticles();

/***********************
 * DRAW LOOP
 ***********************/
function draw(){
  ctx.setTransform(1,0,0,1,0,0);
  ctx.clearRect(0,0,W,H);

  camX+=velX;
  camY+=velY;
  velX*=0.92;
  velY*=0.92;

  zoom+=(targetZoom-zoom)*0.1;
  rotation+=rotVel;
  rotVel*=0.95;

  ctx.translate(W/2,H/2);
  ctx.scale(zoom,zoom);
  ctx.rotate(rotation);
  ctx.translate(-W/2,-H/2);

  const fw=W*2, fh=H*2;

  for(let ox=-1;ox<=1;ox++){
    for(let oy=-1;oy<=1;oy++){
      drawTile(ox*fw,oy*fh);
    }
  }

  requestAnimationFrame(draw);
}
draw();

function drawTile(offX,offY){
  for(const p of particles){
    p.x+=p.vx;
    p.y+=p.vy;

    const sx=(p.x+offX-camX*p.depth);
    const sy=(p.y+offY-camY*p.depth);

    if(sx<-100||sx>W+100||sy<-100||sy>H+100) continue;

    // ðŸ”‘ cache screen position for hit test
    p.sx = sx;
    p.sy = sy;

    const pulse=audioLevel*4*p.depth;
    ctx.beginPath();
    ctx.arc(sx,sy,p.r+pulse,0,Math.PI*2);
    ctx.fillStyle=`rgba(255,255,255,${p.a})`;
    ctx.fill();
  }
}

/***********************
 * AUDIO
 ***********************/
function unlockAudio(){
  if(!audioCtx){
    audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  }
  if(audioCtx.state!=="running") audioCtx.resume();
}

/***********************
 * POINTER / SCROLL
 ***********************/
canvas.addEventListener("pointerdown",e=>{
  if(playing) return;
  dragging=true;
  lastX=e.clientX;
  lastY=e.clientY;
});

addEventListener("pointermove",e=>{
  if(!dragging||playing) return;
  velX -= (e.clientX-lastX)*0.03;
  velY -= (e.clientY-lastY)*0.03;
  rotVel += (e.clientX-lastX)*0.000015;
  lastX=e.clientX;
  lastY=e.clientY;
});

addEventListener("pointerup",()=>dragging=false);
addEventListener("pointercancel",()=>dragging=false);

addEventListener("wheel",e=>{
  if(playing) return;
  if(e.ctrlKey){
    targetZoom=Math.min(2,Math.max(0.6,targetZoom-e.deltaY*0.001));
  }else{
    velX+=e.deltaX*0.008;
    velY+=e.deltaY*0.008;
  }
},{passive:true});

/***********************
 * MOBILE GYRO
 ***********************/
if(window.DeviceOrientationEvent){
  window.addEventListener("deviceorientation",e=>{
    velX+=(e.gamma||0)*0.02;
    velY+=(e.beta||0)*0.02;
  });
}

/***********************
 * INTERACTION (PLAY)
 ***********************/
let playing=false;
let currentVideo=null;

canvas.addEventListener("click",e=>{
  if(playing) return;
  unlockAudio();

  const mx=e.clientX;
  const my=e.clientY;

  const hit=particles.find(p=>{
    const dx=mx-p.sx;
    const dy=my-p.sy;
    return Math.hypot(dx,dy)<=p.r+8;
  });

  if(hit){
    explode(hit.x,hit.y);
    playRandom();
  }
});

/***********************
 * EXPLOSION
 ***********************/
function explode(cx,cy){
  for(const p of particles){
    const d=Math.hypot(p.x-cx,p.y-cy);
    if(d<140){
      const f=(1-d/140)*5;
      p.vx+=(p.x-cx)/d*f||0;
      p.vy+=(p.y-cy)/d*f||0;
    }
  }
}

/***********************
 * VIDEO FLOW
 ***********************/
async function playRandom(){
  playing=true;
  fade(1);

  const res=await fetch(API);
  const data=await res.json();
  if(!data.ok) return reset();

  setTimeout(()=>playVideo(data.url),400);
}

function playVideo(url){
  const vid=document.createElement("video");
  currentVideo=vid;
  vid.src=url;
  vid.muted=true;
  vid.autoplay=true;
  vid.playsInline=true;
  vid.style.opacity=0;
  document.body.appendChild(vid);

  vid.onplaying=()=>{
    vid.style.opacity=1;
    setTimeout(()=>vid.muted=false,200);
    if(audioReady) attachAudio(vid);
  };

  vid.onclick=exitVideo;
  vid.onended=exitVideo;
}

function exitVideo(){
  if(!currentVideo) return;
  fade(1);
  currentVideo.style.opacity=0;
  setTimeout(()=>{
    currentVideo.remove();
    audioReady=true;
    reset();
  },350);
}

/***********************
 * AUDIO ANALYSER
 ***********************/
function attachAudio(video){
  if(mediaSource) return;
  mediaSource=audioCtx.createMediaElementSource(video);
  analyser=audioCtx.createAnalyser();
  analyser.fftSize=64;
  mediaSource.connect(analyser);
  analyser.connect(audioCtx.destination);

  const arr=new Uint8Array(analyser.frequencyBinCount);
  (function loop(){
    if(!playing) return;
    analyser.getByteFrequencyData(arr);
    audioLevel=arr.reduce((a,b)=>a+b,0)/arr.length/255;
    requestAnimationFrame(loop);
  })();
}

/***********************
 * HELPERS
 ***********************/
function fade(v){ document.getElementById("fade").style.opacity=v; }

function reset(){
  fade(0);
  playing=false;
  audioLevel=0;
  camX=camY=velX=velY=0;
  targetZoom=zoom=1;
  rotation=rotVel=0;
  createParticles();
}
</script>

</body>
</html>
