<!doctype html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Archive</title>

<style>
html,body{
  margin:0;
  width:100%;
  height:100%;
  background:#000;
  overflow:hidden;
}
canvas{ position:fixed; inset:0; }

#fade{
  position:fixed;
  inset:0;
  background:#000;
  opacity:0;
  pointer-events:none;
  transition:opacity .45s ease;
  z-index:5;
}

video{
  position:fixed;
  inset:0;
  width:100%;
  height:100%;
  object-fit:cover;
  background:#000;
  z-index:10;
  transition:opacity .4s ease;
}

#uploader{
  position:fixed;
  opacity:0;
  pointer-events:none;
}
</style>
</head>

<body>

<canvas id="c"></canvas>
<div id="fade"></div>

<input id="uploader"
       type="file"
       accept="video/mp4,video/*"
       capture="environment">

<script>
const API="/api/random";
const UPLOAD_API="/api/upload-url";

/***********************
 * AUDIO STATE
 ***********************/
let audioCtx=null, analyser=null, mediaSource=null;
let audioReady=false;

/***********************
 * CAMERA INERTIA
 ***********************/
let camX=0, camY=0;
let velX=0, velY=0;
let dragging=false;
let lastX=0,lastY=0;

const FRICTION=0.95;
const DRAG_SPEED=1;
const VELOCITY_SCALE=0.9;

/***********************
 * CANVAS
 ***********************/
const canvas=document.getElementById("c");
const ctx=canvas.getContext("2d");
let W,H;

function resize(){
  W=canvas.width=innerWidth;
  H=canvas.height=innerHeight;
}
addEventListener("resize",resize);
resize();

/***********************
 * PARTICLES
 ***********************/
const DEPTHS=[0.5,0.75,1];
let particles=[];
let audioLevel=0;

function createParticles(){
  particles=[];
  const TOTAL=90;
  const UPLOAD_COUNT=Math.floor(TOTAL*0.05);
  let created=0;

  for(const d of DEPTHS){
    for(let i=0;i<30;i++){
      const isUpload=created<UPLOAD_COUNT;
      created++;

      particles.push({
        x:Math.random()*W*2,
        y:Math.random()*H*2,
        depth:d,
        r:isUpload ? 7*d : (Math.random()*2+1)*d,
        vx:(Math.random()-.5)*0.25*d,
        vy:(Math.random()-.5)*0.25*d,
        a:isUpload ? 1 : 0.15+d*0.6,
        exploding:false,
        isUpload
      });
    }
  }
}
createParticles();

/***********************
 * MODULO
 ***********************/
const mod=(n,m)=>((n%m)+m)%m;

/***********************
 * UPLOAD STATE
 ***********************/
let uploading=false;
let uploadProgress=0;

/***********************
 * DRAW LOOP
 ***********************/
function draw(){
  ctx.clearRect(0,0,W,H);

  if(!dragging){
    camX+=velX;
    camY+=velY;
    velX*=FRICTION;
    velY*=FRICTION;
  }

  const fw=W*2, fh=H*2;

  for(const p of particles){
    p.x=mod(p.x+p.vx,fw);
    p.y=mod(p.y+p.vy,fh);

    const rx=mod(p.x-camX*p.depth,fw);
    const ry=mod(p.y-camY*p.depth,fh);

    const sx=rx-fw/2+W/2;
    const sy=ry-fh/2+H/2;

    if(sx<-80||sx>W+80||sy<-80||sy>H+80) continue;

    const pulse=audioLevel*4*p.depth;

    if(p.isUpload){
      ctx.beginPath();
      ctx.arc(sx,sy,p.r+pulse,0,Math.PI*2);
      ctx.strokeStyle="rgba(255,255,255,0.9)";
      ctx.lineWidth=2.5;
      ctx.stroke();

      ctx.beginPath();
      ctx.arc(sx,sy,(p.r+pulse)*0.45,0,Math.PI*2);
      ctx.stroke();
    }else{
      ctx.beginPath();
      ctx.arc(sx,sy,p.r+pulse,0,Math.PI*2);
      ctx.fillStyle=`rgba(255,255,255,${p.a})`;
      ctx.fill();
    }
  }

  if(uploading){
    ctx.beginPath();
    ctx.arc(W/2,H/2,22,-Math.PI/2,
      -Math.PI/2+Math.PI*2*uploadProgress);
    ctx.strokeStyle="#fff";
    ctx.lineWidth=3;
    ctx.stroke();
  }

  requestAnimationFrame(draw);
}
draw();

/***********************
 * INPUT
 ***********************/
canvas.addEventListener("pointerdown",e=>{
  if(playing||uploading) return;
  dragging=true;
  lastX=e.clientX;
  lastY=e.clientY;
  velX=velY=0;
});

addEventListener("pointermove",e=>{
  if(!dragging||playing||uploading) return;
  const dx=e.clientX-lastX;
  const dy=e.clientY-lastY;
  camX-=dx*DRAG_SPEED;
  camY-=dy*DRAG_SPEED;
  velX=-dx*VELOCITY_SCALE;
  velY=-dy*VELOCITY_SCALE;
  lastX=e.clientX;
  lastY=e.clientY;
});

addEventListener("pointerup",()=>dragging=false);

/***********************
 * CLICK
 ***********************/
let playing=false;
let currentVideo=null;
const uploader=document.getElementById("uploader");

canvas.addEventListener("click",async e=>{
  if(playing||dragging||uploading) return;

  const r=canvas.getBoundingClientRect();
  const mx=e.clientX-r.left;
  const my=e.clientY-r.top;

  const fw=W*2, fh=H*2;

  for(const p of particles){
    const rx=mod(p.x-camX*p.depth,fw);
    const ry=mod(p.y-camY*p.depth,fh);
    const sx=rx-fw/2+W/2;
    const sy=ry-fh/2+H/2;

    if(Math.hypot(mx-sx,my-sy)<=p.r+14){
      if(p.isUpload){
        uploader.value="";
        uploader.click();
      }else{
        explode(p.x,p.y);
        playRandom();
      }
      break;
    }
  }
});

/***********************
 * UPLOAD â†’ R2
 ***********************/
uploader.addEventListener("change",async()=>{
  if(!uploader.files.length) return;
  const file=uploader.files[0];

  uploading=true;
  uploadProgress=0;

  const meta=await fetch(UPLOAD_API,{method:"POST"}).then(r=>r.json());

  await fetch(meta.uploadUrl,{
    method:"PUT",
    headers:{
      "Content-Type":"video/mp4"
    },
    body:file
  });

  uploading=false;
  uploadProgress=0;
  reset();
});

/***********************
 * EXPLOSION
 ***********************/
function explode(cx,cy){
  for(const p of particles){
    const d=Math.hypot(p.x-cx,p.y-cy);
    if(d<140){
      const f=(1-d/140)*6;
      p.vx+=(p.x-cx)/d*f||0;
      p.vy+=(p.y-cy)/d*f||0;
      p.exploding=true;
    }
  }
}

/***********************
 * VIDEO FLOW (unchanged)
 ***********************/
async function playRandom(){ /* unchanged */ }
function playVideo(url){ /* unchanged */ }
function exitVideo(){ /* unchanged */ }

/***********************
 * HELPERS
 ***********************/
function reset(){
  uploading=false;
  camX=camY=velX=velY=0;
  createParticles();
}
</script>

</body>
</html>
