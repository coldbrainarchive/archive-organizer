<script>
const API = "/api/random";

/***********************
 * AUDIO STATE
 ***********************/
let audioCtx=null, analyser=null, mediaSource=null;
let audioReady=false;

/***********************
 * CAMERA (INFINITE FIELD)
 ***********************/
let camX=0, camY=0;
let targetCamX=0, targetCamY=0;
let dragging=false;
let lastX=0, lastY=0;

/***********************
 * CANVAS
 ***********************/
const canvas=document.getElementById("c");
const ctx=canvas.getContext("2d");
let W,H;

function resize(){
  W=canvas.width=innerWidth;
  H=canvas.height=innerHeight;
}
addEventListener("resize",resize);
resize();

/***********************
 * PARTICLES
 ***********************/
let particles=[];
let audioLevel=0;

function createParticles(){
  particles = Array.from({length:90},()=>({
    x:Math.random()*W*2,
    y:Math.random()*H*2,
    r:Math.random()*3+1,
    vx:(Math.random()-.5)*.4,
    vy:(Math.random()-.5)*.4,
    a:Math.random()*.6+.2,
    exploding:false
  }));
}
createParticles();

/***********************
 * DRAW LOOP (SEAMLESS)
 ***********************/
function draw(){
  ctx.clearRect(0,0,W,H);

  camX += (targetCamX-camX)*0.08;
  camY += (targetCamY-camY)*0.08;

  const fw = W * 2;
  const fh = H * 2;

  // draw 3x3 tiled world (NO DEAD ZONES)
  for(let ox=-1; ox<=1; ox++){
    for(let oy=-1; oy<=1; oy++){
      drawTile(ox*fw, oy*fh);
    }
  }

  requestAnimationFrame(draw);
}
draw();

function drawTile(offX, offY){
  for(const p of particles){
    const sx = p.x + offX - camX;
    const sy = p.y + offY - camY;

    if(sx<-50||sx>W+50||sy<-50||sy>H+50) continue;

    const pulse=audioLevel*4;
    ctx.beginPath();
    ctx.arc(sx,sy,p.r+pulse,0,Math.PI*2);
    ctx.fillStyle=`rgba(255,255,255,${p.a})`;
    ctx.fill();
  }
}

/***********************
 * AUDIO
 ***********************/
function unlockAudio(){
  if(!audioCtx){
    audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  }
  if(audioCtx.state!=="running") audioCtx.resume();
}

/***********************
 * INTERACTION (CAMERA)
 ***********************/
canvas.addEventListener("pointerdown",e=>{
  if(playing) return;
  dragging=true;
  lastX=e.clientX;
  lastY=e.clientY;
});

addEventListener("pointermove",e=>{
  if(!dragging||playing) return;
  targetCamX -= (e.clientX-lastX)*0.6;
  targetCamY -= (e.clientY-lastY)*0.6;
  lastX=e.clientX;
  lastY=e.clientY;
});

addEventListener("pointerup",()=>dragging=false);
addEventListener("pointercancel",()=>dragging=false);

addEventListener("wheel",e=>{
  if(playing) return;
  targetCamX+=e.deltaX*0.4;
  targetCamY+=e.deltaY*0.4;
},{passive:true});

/***********************
 * INTERACTION (PLAY)
 ***********************/
let playing=false;
let currentVideo=null;

canvas.addEventListener("click",e=>{
  if(playing) return;
  unlockAudio();

  const r=canvas.getBoundingClientRect();
  const x=e.clientX-r.left+camX;
  const y=e.clientY-r.top+camY;

  if(particles.some(p=>Math.hypot(x-p.x,y-p.y)<=p.r+10)){
    explode(x,y);
    playRandom();
  }
});

/***********************
 * EXPLOSION
 ***********************/
function explode(cx,cy){
  for(const p of particles){
    const d=Math.hypot(p.x-cx,p.y-cy);
    if(d<140){
      const f=(1-d/140)*6;
      p.vx+=(p.x-cx)/d*f||0;
      p.vy+=(p.y-cy)/d*f||0;
      p.exploding=true;

      const fade=setInterval(()=>{
        p.a-=0.05;
        if(p.a<=0){
          p.a=0;
          clearInterval(fade);
        }
      },16);
    }
  }
}

/***********************
 * VIDEO FLOW
 ***********************/
async function playRandom(){
  playing=true;
  setTimeout(()=>fade(1),200);

  const res=await fetch(API);
  const data=await res.json();
  if(!data.ok) return reset();

  setTimeout(()=>playVideo(data.url),420);
}

function playVideo(url){
  const vid=document.createElement("video");
  currentVideo=vid;

  vid.src=url;
  vid.muted=true;
  vid.autoplay=true;
  vid.playsInline=true;
  vid.preload="auto";
  vid.style.opacity="0";
  vid.style.pointerEvents="auto";
  document.body.appendChild(vid);

  vid.addEventListener("playing",()=>{
    vid.style.opacity="1";
    setTimeout(()=>vid.muted=false,200);
    if(audioReady) attachAudio(vid);
  });

  vid.addEventListener("pointerdown",exitVideo);
  vid.onended=cleanup;
  vid.onerror=cleanup;

  function cleanup(){
    audioReady=true;
    fade(1);
    vid.style.opacity="0";
    setTimeout(()=>{ removeVideo(); reset(); },350);
  }
}

/***********************
 * EXIT VIDEO
 ***********************/
function exitVideo(){
  if(!currentVideo) return;
  fade(1);
  currentVideo.style.opacity="0";
  setTimeout(()=>{ removeVideo(); reset(); },350);
}

function removeVideo(){
  if(currentVideo){
    currentVideo.pause();
    currentVideo.remove();
    currentVideo=null;
  }
}

/***********************
 * AUDIO ANALYSER
 ***********************/
function attachAudio(video){
  if(mediaSource) return;
  mediaSource=audioCtx.createMediaElementSource(video);
  analyser=audioCtx.createAnalyser();
  analyser.fftSize=64;
  mediaSource.connect(analyser);
  analyser.connect(audioCtx.destination);

  const arr=new Uint8Array(analyser.frequencyBinCount);
  (function loop(){
    if(!playing) return;
    analyser.getByteFrequencyData(arr);
    audioLevel=arr.reduce((a,b)=>a+b,0)/arr.length/255;
    requestAnimationFrame(loop);
  })();
}

/***********************
 * HELPERS
 ***********************/
function fade(v){ document.getElementById("fade").style.opacity=v; }

function reset(){
  fade(0);
  playing=false;
  audioLevel=0;
  camX=camY=targetCamX=targetCamY=0;
  createParticles();
}
</script>
